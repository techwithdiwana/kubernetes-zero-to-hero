pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    ROOT_DIR = "day13-techwithdiwana_gcp_llm_cluster"

    FRONTEND_DIR = "${ROOT_DIR}/frontend"
    NODE_DIR     = "${ROOT_DIR}/backend-node"
    FASTAPI_DIR  = "${ROOT_DIR}/backend-fastapi"

    TESTS_DIR    = "${ROOT_DIR}/tests"
    API_TEST_DIR = "${ROOT_DIR}/tests/api"
    UI_TEST_DIR  = "${ROOT_DIR}/tests/ui"

    FRONTEND_IMAGE = "twd-frontend"
    NODE_IMAGE     = "twd-backend-node"
    FASTAPI_IMAGE  = "twd-backend-fastapi"

    IMAGE_TAG = "ci-${BUILD_NUMBER}"

    FASTAPI_CONTAINER = "twd_fastapi_ci"
    FASTAPI_HOST_PORT = "9001"
    FASTAPI_CONT_PORT = "8000"

    UI_BASE_URL = "https://example.com"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh '''
          set -e
          echo "repo root:"
          ls -la
        '''
      }
    }

    stage('Validate Repo Paths') {
      steps {
        sh '''
          set -e
          test -d "${FRONTEND_DIR}"
          test -d "${NODE_DIR}"
          test -d "${FASTAPI_DIR}"
          test -d "${API_TEST_DIR}"
          test -d "${UI_TEST_DIR}"
          echo "all required paths exist"
        '''
      }
    }

    stage('Frontend: Docker Build') {
      steps {
        sh '''
          set -e
          echo "building frontend image..."
          cd "${FRONTEND_DIR}"
          docker build -t ${FRONTEND_IMAGE}:${IMAGE_TAG} .
        '''
      }
    }

    stage('Backend Node: Docker Build') {
      steps {
        sh '''
          set -e
          echo "building node backend image..."
          cd "${NODE_DIR}"
          docker build -t ${NODE_IMAGE}:${IMAGE_TAG} .
        '''
      }
    }

    stage('Backend FastAPI: Docker Build') {
      steps {
        sh '''
          set -e
          echo "building fastapi image..."
          cd "${FASTAPI_DIR}"
          docker build -t ${FASTAPI_IMAGE}:${IMAGE_TAG} .
        '''
      }
    }

    stage('Start FastAPI + Health Check') {
      steps {
        sh '''
          set -e

          echo "removing old fastapi container if exists..."
          docker rm -f ${FASTAPI_CONTAINER} || true

          echo "starting fastapi container..."
          docker run -d --name ${FASTAPI_CONTAINER} \
            -p 127.0.0.1:${FASTAPI_HOST_PORT}:${FASTAPI_CONT_PORT} \
            ${FASTAPI_IMAGE}:${IMAGE_TAG}

          echo "waiting for fastapi /healthz..."
          for i in $(seq 1 45); do
            if curl -sS http://127.0.0.1:${FASTAPI_HOST_PORT}/healthz >/dev/null 2>&1; then
              echo "fastapi is healthy"
              curl -sS http://127.0.0.1:${FASTAPI_HOST_PORT}/healthz || true
              exit 0
            fi
            echo "retry $i"
            sleep 2
          done

          echo "fastapi not ready"
          echo "container logs:"
          docker logs --tail 200 ${FASTAPI_CONTAINER} || true
          exit 1
        '''
      }
    }

    stage('API Smoke Test Script') {
      steps {
        sh '''
          set -e
          echo "running api smoke script..."
          chmod +x "${API_TEST_DIR}/smoke.sh"
          bash "${API_TEST_DIR}/smoke.sh"
        '''
      }
    }

    stage('UI Tests (Playwright)') {
      steps {
        sh '''
          set -e

          echo "running playwright ui tests..."
          echo "UI_BASE_URL=${UI_BASE_URL}"
          export UI_BASE_URL="${UI_BASE_URL}"

          cd "${UI_TEST_DIR}"

          node -v
          npm -v

          echo "installing ui test dependencies..."
          npm install

          echo "installing playwright browsers..."
          npx playwright install

          echo "cleaning old reports..."
          rm -rf playwright-report test-results || true

          echo "running playwright tests..."
          npx playwright test --reporter=html

          echo "playwright report generated:"
          ls -la playwright-report || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: "${ROOT_DIR}/tests/ui/playwright-report/**", allowEmptyArchive: true
          archiveArtifacts artifacts: "${ROOT_DIR}/tests/ui/test-results/**", allowEmptyArchive: true
        }
      }
    }

    stage('Images Summary') {
      steps {
        sh '''
          set -e
          echo "docker images summary:"
          docker image ls | head -n 30
        '''
      }
    }
  }

  post {
    always {
      echo "cleanup containers..."
      sh '''
        docker rm -f ${FASTAPI_CONTAINER} || true
      '''
    }
  }
}
