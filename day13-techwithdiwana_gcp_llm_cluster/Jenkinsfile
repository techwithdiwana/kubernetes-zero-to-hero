pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    ROOT_DIR     = "day13-techwithdiwana_gcp_llm_cluster"
    FRONTEND_DIR = "${ROOT_DIR}/frontend"
    NODE_DIR     = "${ROOT_DIR}/backend-node"
    FASTAPI_DIR  = "${ROOT_DIR}/backend-fastapi"

    TESTS_DIR    = "${ROOT_DIR}/tests"
    API_TEST_DIR = "${ROOT_DIR}/tests/api"
    UI_TEST_DIR  = "${ROOT_DIR}/tests/ui"

    FRONTEND_IMAGE = "twd-frontend"
    NODE_IMAGE     = "twd-backend-node"
    FASTAPI_IMAGE  = "twd-backend-fastapi"

    IMAGE_TAG = "ci-${BUILD_NUMBER}"

    FASTAPI_CONTAINER = "twd_fastapi_ci"
    FASTAPI_HOST_PORT = "9001"
    FASTAPI_CONT_PORT = "8000"

    PW_REPORT_DIR = "playwright-report"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh '''
          set -e
          echo "Repo root files:"
          ls -la
        '''
      }
    }

    stage('Validate Repo Paths') {
      steps {
        sh '''
          set -e
          test -d "${FRONTEND_DIR}"
          test -d "${NODE_DIR}"
          test -d "${FASTAPI_DIR}"
          test -d "${TESTS_DIR}"
          test -d "${API_TEST_DIR}"
          echo "Repo paths look OK"
        '''
      }
    }

    stage('Frontend: Docker Build') {
      steps {
        sh '''
          set -e
          cd "${FRONTEND_DIR}"
          docker build -t ${FRONTEND_IMAGE}:${IMAGE_TAG} .
          echo "Frontend image built: ${FRONTEND_IMAGE}:${IMAGE_TAG}"
        '''
      }
    }

    stage('Backend Node: Docker Build') {
      steps {
        sh '''
          set -e
          cd "${NODE_DIR}"
          docker build -t ${NODE_IMAGE}:${IMAGE_TAG} .
          echo "Node backend image built: ${NODE_IMAGE}:${IMAGE_TAG}"
        '''
      }
    }

    stage('Backend FastAPI: Docker Build') {
      steps {
        sh '''
          set -e
          cd "${FASTAPI_DIR}"
          docker build -t ${FASTAPI_IMAGE}:${IMAGE_TAG} .
          echo "FastAPI image built: ${FASTAPI_IMAGE}:${IMAGE_TAG}"
        '''
      }
    }

    stage('Start FastAPI Container') {
      steps {
        sh '''
          set -e

          echo "Cleaning old container if exists..."
          docker rm -f ${FASTAPI_CONTAINER} || true

          echo "Starting FastAPI container..."
          docker run -d --name ${FASTAPI_CONTAINER} -p 127.0.0.1:${FASTAPI_HOST_PORT}:${FASTAPI_CONT_PORT} ${FASTAPI_IMAGE}:${IMAGE_TAG}

          echo "Waiting for FastAPI /healthz to become ready..."
          for i in $(seq 1 45); do
            if curl -sS http://127.0.0.1:${FASTAPI_HOST_PORT}/healthz >/dev/null 2>&1; then
              echo "FastAPI is healthy"
              curl -sS http://127.0.0.1:${FASTAPI_HOST_PORT}/healthz
              exit 0
            fi

            echo "Not ready yet... retry $i"
            sleep 2
          done

          echo "FastAPI did not become healthy"
          echo "Container status:"
          docker ps -a | grep ${FASTAPI_CONTAINER} || true

          echo "Last 200 logs:"
          docker logs --tail 200 ${FASTAPI_CONTAINER} || true

          exit 1
        '''
      }
    }

    stage('API Smoke Test Script (tests/api/smoke.sh)') {
      steps {
        sh '''
          set -e
          echo "Running API smoke script: ${API_TEST_DIR}/smoke.sh"

          if [ -f "${API_TEST_DIR}/smoke.sh" ]; then
            chmod +x "${API_TEST_DIR}/smoke.sh"
            bash "${API_TEST_DIR}/smoke.sh"
          else
            echo "smoke.sh not found at ${API_TEST_DIR}/smoke.sh"
            exit 1
          fi
        '''
      }
    }

    stage('UI Tests (Playwright)') {
      steps {
        sh '''
          set -e

          echo "Checking UI tests folder..."
          if [ ! -d "${UI_TEST_DIR}" ]; then
            echo "UI tests folder not found: ${UI_TEST_DIR}"
            echo "Skipping Playwright stage (folder missing)"
            exit 0
          fi

          echo "Running Playwright UI tests..."
          node -v
          npm -v

          cd "${UI_TEST_DIR}"
          ls -la

          if [ -f package.json ]; then
            npm ci
          else
            echo "package.json not found in tests/ui"
            echo "Skipping Playwright stage (no package.json)"
            exit 0
          fi

          npx playwright install --with-deps
          npx playwright test

          echo "Playwright UI tests completed"
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: "${ROOT_DIR}/tests/ui/${PW_REPORT_DIR}/**", allowEmptyArchive: true
        }
      }
    }

    stage('Images Summary') {
      steps {
        sh '''
          set -e
          echo "Built images summary:"
          docker image ls | head -n 30
        '''
      }
    }
  }

  post {
    always {
      echo "CI pipeline finished"
      sh '''
        echo "Cleanup: removing test container if exists..."
        docker rm -f ${FASTAPI_CONTAINER} || true
      '''
    }
  }
}
